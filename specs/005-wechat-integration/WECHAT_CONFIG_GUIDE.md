# 微信公众号手动配置指南

## 重要说明

由于本项目是个人开发者运营，**无法实现标准的OAuth授权流程**。用户需要手动配置微信公众号的AppID和Secret来接入平台。

## 技术限制说明

### 为什么不能使用OAuth授权?

1. **个人开发者限制**：个人开发者无法在自己的网站中唤起微信公众号的OAuth授权流程
2. **企业资质要求**：OAuth授权需要在微信开放平台注册网站应用,需要企业认证和备案域名
3. **替代方案**：采用手动配置方式,用户直接提供公众号的AppID和Secret

### 账号类型限制

- **个人主体公众号**：不支持发布功能,只能获取信息
- **企业主体公众号**：支持完整的发布功能

请在配置前确认您的公众号主体类型。

## 配置步骤总览

1. ✅ 获取微信公众号的AppID和Secret
2. ✅ 配置IP白名单（必需）
3. ✅ 配置安全域名（推荐）
4. ✅ 在SocialWiz中添加公众号配置
5. ✅ 测试配置是否正常工作

## 步骤1：获取公众号 AppID 和 AppSecret

### 1.1 登录微信公众平台

**网站地址**: https://mp.weixin.qq.com/

### 1.2 查看AppID

1. 登录后进入"开发" → "基本配置"
2. 在页面顶部可以看到 **AppID(应用ID)**
3. 复制并保存该AppID

### 1.3 获取AppSecret

1. 在同一页面找到 **AppSecret(应用密钥)**
2. 如果未设置,点击"生成"按钮
3. **重要**：生成后立即复制保存,关闭页面后将无法再次查看
4. 如果忘记,需要点击"重置"（重置后旧密钥将失效）

### 1.4 确认公众号主体类型

1. 进入"设置与开发" → "公众号设置" → "账号详情"
2. 查看"主体信息"部分,确认是"个人"还是"企业"
3. **重要提示**：
   - 个人主体：无法使用发布功能
   - 企业主体：支持完整发布功能

---

## 步骤2：配置IP白名单（必需）

微信公众号API要求调用接口的服务器IP必须在白名单中。

### 2.1 获取服务器IP地址

**本地开发**：
```bash
# Windows PowerShell
(Invoke-WebRequest -Uri "https://api.ipify.org").Content

# 或访问网站
# https://www.whatismyip.com/
```

**生产环境**：
- 使用云服务器提供的公网IP
- 注意：如果使用负载均衡,需要添加所有服务器的IP

### 2.2 在微信公众号后台配置

1. 登录微信公众平台 https://mp.weixin.qq.com/
2. 进入"开发" → "基本配置"
3. 找到"IP白名单"部分,点击"修改"
4. 添加您的服务器IP地址
5. 点击"确定"保存

**重要提示**：
- IP白名单最多可配置200个
- 未配置白名单会导致API调用返回错误40164
- IP地址变更后需要及时更新白名单

---

## 步骤3：配置安全域名（推荐）

安全域名用于JS-SDK等功能,建议配置以支持未来功能扩展。

### 3.1 在微信公众号后台配置

1. 进入"设置与开发" → "公众号设置" → "功能设置"
2. 找到"JS接口安全域名",点击"设置"
3. 按照提示下载验证文件（如：MP_verify_xxx.txt）
4. 将验证文件放到您网站的根目录（Next.js项目放在`public`目录）
5. 确保可以通过 `https://your-domain.com/MP_verify_xxx.txt` 访问
6. 在微信后台填入域名（只填域名,不包含http://或https://）
7. 点击"确定"完成验证

**本地开发示例**（使用Localtunnel）：
```bash
# 1. 将验证文件放到 public 目录
cp MP_verify_xxx.txt public/

# 2. 启动开发服务器
pnpm dev

# 3. 启动内网穿透
npx localtunnel --port 3000 --subdomain socialwiz-dev

# 4. 访问验证：https://socialwiz-dev.loca.lt/MP_verify_xxx.txt
# 5. 在微信后台填入：socialwiz-dev.loca.lt
```

---

## 步骤4：在SocialWiz中添加配置

### 4.1 登录SocialWiz

访问您的SocialWiz应用并登录账号。

### 4.2 添加微信公众号

1. 进入"设置" → "平台管理"
2. 点击"添加微信公众号"
3. 在配置表单中填入：
   - **AppID**：您在步骤1中获取的AppID
   - **AppSecret**：您在步骤1中获取的Secret
   - **公众号名称**：可选,用于标识（系统会自动获取）
4. 点击"验证并保存"

### 4.3 系统验证

系统会自动：
1. 使用提供的AppID和Secret调用微信API获取access_token
2. 获取公众号基本信息（名称、类型、主体类型）
3. 检测公众号是否支持发布功能

**验证成功**：
- 显示公众号名称、类型、主体类型
- 如果是企业主体,显示"支持发布功能"
- 配置保存成功

**验证失败**：
- 显示具体错误原因和解决方案
- 常见错误：
  - **40001**：AppSecret错误,请检查配置
  - **40164**：IP白名单未配置,请返回步骤2配置
  - **其他错误**：参考错误码说明

---

## 步骤5：测试配置

### 5.1 访问测试页面

1. 访问 `/test/wechat` 测试页面
2. 查看配置信息是否正确显示
3. 查看access_token是否已获取

### 5.2 测试发布功能

1. 在测试页面输入一段测试文字
2. 点击"发布到微信"
3. 查看发布结果

**个人主体公众号**：
- 会提示不支持发布功能
- 建议升级为企业主体

**企业主体公众号**：
- 发布成功会显示文章链接
- 可以在微信公众号后台查看草稿

---

## 微信公众号API调用机制

### Access Token机制

微信公众号的大多数API接口都需要传入`access_token`参数：

1. **获取access_token**：
   - 接口：`GET https://api.weixin.qq.com/cgi-bin/token`
   - 参数：
     - `grant_type=client_credential`
     - `appid=你的AppID`
     - `secret=你的Secret`
   - 返回：`{"access_token":"xxx", "expires_in":7200}`
   - 有效期：7200秒（2小时）

2. **使用access_token**：
   - 所有业务API都需要在请求中附带access_token
   - 例如：`POST https://api.weixin.qq.com/cgi-bin/draft/add?access_token=xxx`

3. **Token刷新策略**：
   - 每个公众号的access_token是唯一的
   - 重复获取会导致上次的token失效
   - **重要**：需要实现中控服务器统一管理token
   - 建议提前5分钟刷新token,避免临界时间调用失败

### SocialWiz的Token管理

SocialWiz已实现智能token管理：

1. **缓存机制**：token存储在Redis中,避免频繁调用API
2. **过期检测**：每次API调用前检查token是否即将过期
3. **自动刷新**：剩余有效期少于5分钟时自动刷新
4. **分布式锁**：使用Redis锁防止并发获取token导致失效
5. **错误处理**：token失效时自动重新获取

---

## 常见错误处理

### 错误码对照表

| 错误码 | 错误说明 | 解决方案 |
|--------|----------|----------|
| 40001 | AppSecret错误 | 检查配置中的Secret是否正确 |
| 40013 | AppID无效 | 检查配置中的AppID是否正确 |
| 40164 | IP白名单未配置 | 在微信后台配置服务器IP到白名单 |
| 41001 | 缺少access_token | 系统会自动重新获取 |
| 42001 | access_token过期 | 系统会自动刷新token |
| 48001 | API功能未授权 | 公众号主体类型限制,个人主体无法使用发布功能 |
| 45009 | 接口调用超过限制 | 降低调用频率,等待限制解除 |

### 排查步骤

1. **检查AppID和Secret**：
   - 确认复制时没有多余空格
   - 确认Secret未过期或被重置

2. **检查IP白名单**：
   - 确认服务器IP已添加到白名单
   - IP地址变更后及时更新

3. **检查账号类型**：
   - 确认是个人还是企业主体
   - 个人主体无法使用发布功能

4. **查看系统日志**：
   - 在测试页面查看详细错误信息
   - 根据错误码查找解决方案

---

## 配置检查清单

完成以下所有步骤后,您的微信公众号就可以正常使用了：

- [ ] 已获取微信公众号的AppID
- [ ] 已获取微信公众号的AppSecret
- [ ] 已确认公众号主体类型（个人/企业）
- [ ] 已在微信后台配置IP白名单
- [ ] 已在微信后台配置JS接口安全域名（可选）
- [ ] 已上传域名验证文件到`public`目录（如需要）
- [ ] 已在SocialWiz中添加公众号配置
- [ ] 配置验证通过,显示公众号信息
- [ ] 已在测试页面成功获取access_token
- [ ] 已测试发布功能（企业主体）或确认不支持（个人主体）

---

## 相关链接

- **微信公众平台**: https://mp.weixin.qq.com/
- **微信公众号开发文档**: https://developers.weixin.qq.com/doc/offiaccount/Getting_Started/Overview.html
- **微信公众号API文档**: https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html
- **内网穿透工具Localtunnel**: https://localtunnel.github.io/www/

---

## 安全建议

1. **Secret保护**：
   - 切勿将Secret提交到代码仓库
   - 使用环境变量或密钥管理服务
   - 定期轮换Secret

2. **IP白名单**：
   - 只添加必要的服务器IP
   - 定期审查白名单配置
   - IP变更后及时更新

3. **Token安全**：
   - access_token仅在服务器端使用
   - 不要在前端代码中暴露token
   - 使用HTTPS传输

4. **日志审计**：
   - 记录所有API调用
   - 监控异常调用模式
   - 及时发现安全问题

---

## 需要帮助？

如果在配置过程中遇到问题：

1. 查看本文档的"常见错误处理"章节
2. 在测试页面查看详细错误日志
3. 访问微信公众号开发文档
4. 联系SocialWiz技术支持
