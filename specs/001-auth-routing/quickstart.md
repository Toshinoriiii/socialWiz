# Quick Start: 认证路由保护功能

**Feature**: 001-auth-routing  
**Date**: 2025-01-05

## 功能概述

实现应用根路径的认证路由保护。用户访问应用根路径时，系统自动检查登录状态并重定向到相应页面：
- 未登录用户 → 重定向到 `/login`
- 已登录用户 → 重定向到 `/dashboard`（管理页面）

同时，已登录用户访问登录页面时也会被重定向到管理页面。

## 快速测试

### 前置条件

1. 确保应用已启动：`pnpm dev`
2. 确保数据库和 Redis 已配置并运行
3. 确保已有测试用户账号（或使用种子数据）

### 测试场景 1: 未登录用户访问根路径

1. **清除认证信息**:
   - 打开浏览器开发者工具
   - 进入 Application/Storage → Local Storage
   - 删除 `user-storage` key（或清除所有 localStorage）

2. **访问根路径**:
   - 在浏览器中访问 `http://localhost:3000/`
   - 应该自动重定向到 `http://localhost:3000/login`

3. **验证结果**:
   - ✅ URL 变为 `/login`
   - ✅ 显示登录页面
   - ✅ 浏览器控制台无错误

### 测试场景 2: 已登录用户访问根路径

1. **登录用户**:
   - 访问 `http://localhost:3000/login`
   - 使用有效账号登录（如：`test@socialwiz.com` / `Test@123456`）

2. **访问根路径**:
   - 登录成功后，手动访问 `http://localhost:3000/`
   - 应该自动重定向到 `http://localhost:3000/dashboard` 或管理页面

3. **验证结果**:
   - ✅ URL 变为 `/dashboard`（或管理页面路径）
   - ✅ 显示管理页面内容
   - ✅ 用户信息正确显示

### 测试场景 3: 已登录用户访问登录页

1. **前提**: 用户已登录（完成场景 2 的登录步骤）

2. **访问登录页**:
   - 直接访问 `http://localhost:3000/login`
   - 应该自动重定向到管理页面

3. **验证结果**:
   - ✅ URL 变为 `/dashboard`（或管理页面路径）
   - ✅ 不显示登录表单
   - ✅ 直接进入管理页面

### 测试场景 4: Token 过期处理

1. **模拟过期 token**:
   - 在浏览器开发者工具中，修改 localStorage 中的 token 为无效值
   - 或等待 token 自然过期（如果设置了较短的过期时间）

2. **访问根路径**:
   - 访问 `http://localhost:3000/`
   - 应该识别为未登录状态并重定向到登录页

3. **验证结果**:
   - ✅ 正确识别 token 无效
   - ✅ 清除无效 token
   - ✅ 重定向到登录页

### 测试场景 5: 多标签页同步

1. **打开多个标签页**:
   - 标签页 A: 已登录状态，显示管理页面
   - 标签页 B: 打开新标签页，访问 `http://localhost:3000/`

2. **在标签页 A 登出**:
   - 点击登出按钮或清除认证信息

3. **验证标签页 B**:
   - 标签页 B 应该自动检测到登出状态
   - 如果访问受保护页面，应该重定向到登录页

4. **验证结果**:
   - ✅ 多标签页状态同步
   - ✅ 登出后其他标签页正确更新

## API 测试

### 测试 Token 验证端点

使用 curl 或 Postman 测试 `/api/auth/verify` 端点：

```bash
# 获取有效 token（先登录）
TOKEN="your-jwt-token-here"

# 验证 token
curl -X POST http://localhost:3000/api/auth/verify \
  -H "Content-Type: application/json" \
  -d "{\"token\": \"$TOKEN\"}"
```

**预期响应（有效 token）**:
```json
{
  "valid": true,
  "user": {
    "id": "123e4567-e89b-12d3-a456-426614174000",
    "email": "user@example.com",
    "name": "张三"
  }
}
```

**预期响应（无效 token）**:
```json
{
  "valid": false,
  "error": "Token无效或已过期"
}
```

## 常见问题

### Q: 页面出现闪烁或短暂显示错误内容？

**A**: 这是加载状态处理问题。确保在认证检查期间显示加载指示器，避免内容闪烁。

### Q: 重定向循环？

**A**: 检查重定向逻辑，确保：
- 登录页检查已登录状态时，重定向到管理页面
- 管理页面不应该重定向回登录页（除非未登录）
- 根路径的重定向逻辑正确

### Q: Token 验证失败但用户仍显示为已登录？

**A**: 检查错误处理逻辑，确保 token 验证失败时正确更新 Zustand store 状态。

### Q: 多标签页不同步？

**A**: 确保实现了 `storage` 事件监听，并在事件处理中更新 Zustand store。

## 下一步

完成功能测试后，可以：
1. 运行 `/speckit.tasks` 生成实施任务列表
2. 开始实现功能代码
3. 编写单元测试和集成测试
