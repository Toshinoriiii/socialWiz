generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String                @id @default(uuid())
  email            String                @unique
  password         String
  name             String
  avatar           String?
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
  aiGenerationLogs AIGenerationLog[]
  contents         Content[]
  platformAccounts PlatformAccount[]
  wechatConfigs    WechatAccountConfig[]

  @@index([email])
}

model PlatformAccount {
  id               String            @id @default(uuid())
  userId           String
  platform         Platform
  platformUserId   String
  platformUsername String
  accessToken      String
  refreshToken     String?
  tokenExpiry      DateTime?
  isConnected      Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  analytics        Analytics[]
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  contentPlatforms ContentPlatform[]

  @@unique([userId, platform])
  @@index([userId])
}

model Content {
  id               String            @id @default(uuid())
  userId           String
  title            String
  content          String
  coverImage       String?
  images           String[]
  status           ContentStatus     @default(DRAFT)
  aiGenerated      Boolean           @default(false)
  aiModel          String?
  scheduledAt      DateTime?
  publishedAt      DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  contentPlatforms ContentPlatform[]

  @@index([userId, status])
  @@index([scheduledAt])
}

model ContentPlatform {
  id                String               @id @default(uuid())
  contentId         String
  platformAccountId String?
  wechatConfigId    String?
  platformContentId String?
  publishStatus     PublishStatus        @default(PENDING)
  errorMessage      String?
  publishedUrl      String?
  createdAt         DateTime             @default(now())
  analytics         Analytics?
  content           Content              @relation(fields: [contentId], references: [id], onDelete: Cascade)
  platformAccount   PlatformAccount?     @relation(fields: [platformAccountId], references: [id], onDelete: Cascade)
  wechatConfig      WechatAccountConfig? @relation(fields: [wechatConfigId], references: [id], onDelete: Cascade)

  @@index([contentId])
  @@index([platformAccountId])
  @@index([wechatConfigId])
  @@map("content_platforms")
}

model Analytics {
  id                String          @id @default(uuid())
  contentPlatformId String          @unique
  platformAccountId String
  date              DateTime
  views             Int             @default(0)
  likes             Int             @default(0)
  comments          Int             @default(0)
  shares            Int             @default(0)
  followers         Int             @default(0)
  engagementRate    Float           @default(0)
  createdAt         DateTime        @default(now())
  contentPlatform   ContentPlatform @relation(fields: [contentPlatformId], references: [id], onDelete: Cascade)
  platformAccount   PlatformAccount @relation(fields: [platformAccountId], references: [id], onDelete: Cascade)

  @@index([platformAccountId, date])
}

model AIGenerationLog {
  id               String           @id @default(uuid())
  userId           String
  model            String
  prompt           String
  generatedContent String
  type             AIGenerationType
  tokensUsed       Int?
  duration         Int?
  createdAt        DateTime         @default(now())
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model WechatAccountConfig {
  id               String            @id @default(uuid())
  userId           String
  appId            String
  appSecret        String
  accountName      String?
  accountType      String?
  subjectType      String?
  canPublish       Boolean           @default(false)
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  contentPlatforms ContentPlatform[]
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, appId])
  @@index([userId])
  @@map("wechat_account_configs")
}

enum Platform {
  WECHAT
  WEIBO
  DOUYIN
  XIAOHONGSHU
}

enum ContentStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  FAILED
}

enum PublishStatus {
  PENDING
  SUCCESS
  FAILED
}

enum AIGenerationType {
  TEXT
  IMAGE
}
